"""
生成進度頁面 (generating.html)
實現 LLM 生成內容的實時顯示
"""

{% extends "base.html" %}

{% block title %}處理中 - {{ config.SITE_TITLE }}{% endblock %}

{% block extra_css %}
<!-- 添加 Markdown 樣式 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.2.0/github-markdown.min.css">
<style>
    .stream-container {
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
    }

    .markdown-body {
        font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif;
        line-height: 1.6;
        padding: 0.5rem;
    }

    .cursor-blink {
        display: inline-block;
        width: 0.5em;
        height: 1em;
        background-color: #000;
        animation: blink 1s step-end infinite;
        vertical-align: text-bottom;
    }

    @keyframes blink {
        from, to { opacity: 1 }
        50% { opacity: 0 }
    }
</style>
{% endblock %}

{% block page_title %}報告生成中{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">報告生成進度</h5>
                <div>
                    <span class="badge bg-primary" id="statusBadge">{{ report.status.value }}</span>
                </div>
            </div>
            <div class="card-body">
                <!-- 進度顯示 -->
                <div class="progress-section mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span id="statusText">{{ report.status.value }}</span>
                        <span id="progressPercent" class="fw-bold">{{ report.progress | int }}%</span>
                    </div>
                    <div class="progress">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                            role="progressbar" aria-valuenow="{{ report.progress }}" aria-valuemin="0"
                            aria-valuemax="100" style="width: {{ report.progress }}%">
                        </div>
                    </div>
                </div>

                <!-- 生成信息 -->
                <div class="report-info mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item">
                                <span class="text-muted">報告標題：</span>
                                <span class="fw-medium">{{ report.title }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <span class="text-muted">使用模型：</span>
                                <span class="fw-medium">{{ report.ollama_model }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 串流輸出顯示區域 -->
                <h6 class="mb-2">報告生成內容：</h6>
                <div class="stream-container">
                    <div id="streamContent" class="markdown-body">
                        <!-- 生成內容將在這裡顯示 -->
                        <span class="cursor-blink"></span>
                    </div>
                </div>

                <div id="message" class="text-center text-muted mt-3">
                    <small>報告正在生成中，內容將實時更新...</small>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <a href="{{ url_for('auth.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> 返回儀表板
                </a>
                <div id="actionButtons">
                    <!-- 生成完成後的按鈕將放在這裡 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化
    const reportId = {{ report.id }};
    const streamContent = document.getElementById('streamContent');
    const progressBar = document.getElementById('progressBar');
    const progressPercent = document.getElementById('progressPercent');
    const statusText = document.getElementById('statusText');
    const statusBadge = document.getElementById('statusBadge');
    const message = document.getElementById('message');
    const actionButtons = document.getElementById('actionButtons');

    // 初始狀態
    let initialStatus = "{{ report.status.value }}";
    let initialProgress = {{ report.progress }};
    let generatedContent = '';

    // 配置 marked
    marked.setOptions({
        breaks: true,     // 啟用換行轉換
        gfm: true,        // 啟用 GitHub 風格 Markdown
        smartLists: true, // 改善列表渲染
        smartypants: true // 改善標點符號
    });

    // 只有在狀態不是已完成或失敗時才設置 EventSource
    if (initialStatus !== 'completed' && initialStatus !== 'failed') {
        // 建立 SSE 連接
        const evtSource = new EventSource(`/stream/${reportId}`);

        // 監聽一般消息事件
        evtSource.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);

                // 處理心跳
                if (data.heartbeat) {
                    return;
                }

                // 處理生成的內容片段
                if (data.chunk) {
                    // 添加到內容並更新顯示
                    generatedContent += data.chunk;
                    updateContent();
                }
            } catch (err) {
                console.error('處理事件數據時出錯:', err);
            }
        };

        // 處理完成事件
        evtSource.addEventListener('done', function(e) {
            console.log('生成完成');
            evtSource.close();

            // 最後更新一次內容
            updateContent();

            // 移除閃爍光標
            const cursor = streamContent.querySelector('.cursor-blink');
            if (cursor) cursor.remove();

            // 更新狀態
            statusText.textContent = '生成完成';
            statusBadge.textContent = '完成';
            statusBadge.className = 'badge bg-success';
            message.innerHTML = '<div class="alert alert-success">報告生成完成！</div>';
        });

        // 處理錯誤事件
        evtSource.addEventListener('error', function(e) {
            console.error('SSE 連接錯誤', e);
            evtSource.close();

            statusText.textContent = '生成失敗';
            statusBadge.textContent = '失敗';
            statusBadge.className = 'badge bg-danger';
            message.innerHTML = '<div class="alert alert-danger">報告生成過程中發生錯誤</div>';

            // 移除閃爍光標
            const cursor = streamContent.querySelector('.cursor-blink');
            if (cursor) cursor.remove();
        });
    }

    // 使用防抖更新內容，避免頻繁DOM操作
    let updateTimeout = null;
    function updateContent() {
        if (updateTimeout) {
            clearTimeout(updateTimeout);
        }

        updateTimeout = setTimeout(() => {
            // 渲染 Markdown
            const htmlContent = marked.parse(generatedContent);

            // 更新顯示，保留光標
            streamContent.innerHTML = htmlContent + '<span class="cursor-blink"></span>';

            // 滾動到底部，以便查看最新內容
            streamContent.parentElement.scrollTop = streamContent.parentElement.scrollHeight;
        }, 100); // 100ms 防抖
    }

    // 同時保留原來的進度檢查邏輯
    function checkProgress() {
        fetch(`/generating_status/${reportId}/check`)
            .then(response => response.json())
            .then(data => {
                // 更新進度條
                if (data.progress !== undefined) {
                    progressBar.style.width = data.progress + '%';
                    progressBar.setAttribute('aria-valuenow', data.progress);
                    progressPercent.textContent = Math.round(data.progress) + '%';
                }

                // 更新狀態
                if (data.status) {
                    statusText.textContent = data.status;
                    statusBadge.textContent = data.status;

                    // 根據狀態更新徽章顏色
                    if (data.status === 'completed') {
                        statusBadge.className = 'badge bg-success';
                    } else if (data.status === 'failed') {
                        statusBadge.className = 'badge bg-danger';
                    } else {
                        statusBadge.className = 'badge bg-primary';
                    }
                }

                // 檢查是否完成
                if (data.status === 'completed') {
                    // 生成檢視按鈕
                    actionButtons.innerHTML = `
                        <a href="${data.redirect_url}" class="btn btn-success">
                            <i class="fas fa-eye me-1"></i> 查看報告
                        </a>
                    `;

                    // 移除閃爍光標
                    const cursor = streamContent.querySelector('.cursor-blink');
                    if (cursor) cursor.remove();

                    return; // 不再繼續檢查
                }
                else if (data.status === 'failed') {
                    // 顯示錯誤訊息
                    message.innerHTML = `<div class="alert alert-danger">${data.message || '報告生成失敗'}</div>`;

                    // 移除閃爍光標
                    const cursor = streamContent.querySelector('.cursor-blink');
                    if (cursor) cursor.remove();

                    return; // 不再繼續檢查
                }

                // 繼續檢查進度
                setTimeout(checkProgress, 1000);
            })
            .catch(error => {
                console.error('檢查進度時發生錯誤:', error);
                // 發生錯誤時也繼續檢查
                setTimeout(checkProgress, 2000);
            });
    }

    // 啟動進度檢查
    checkProgress();
});
</script>
{% endblock %}